# syntax=docker/dockerfile:1

########################  pruner stage  ########################
FROM oven/bun:1 AS pruner
WORKDIR /repo
RUN bun install --global turbo@2

COPY . .

# FUTURE: move to the SST/Pulumi script
RUN turbo prune @hebo/mcp --docker

########################  installer + builder stage  ########################
FROM oven/bun:1 AS builder
WORKDIR /repo

COPY --from=pruner /repo/out/json/ ./
# FUTURE: remove this once turbo prune is more stable
RUN bun install --lockfile-only
RUN bun install --frozen-lockfile --ignore-scripts

COPY --from=pruner /repo/out/full/ ./
RUN bun run build

########################  runner stage  ########################
FROM oven/bun:1-slim AS runner
WORKDIR /app

COPY --from=builder /repo/apps/mcp/dist/server .
COPY --from=builder /repo/apps/mcp/dist/frontend.css ./dist/
COPY --from=builder /repo/apps/mcp/dist/frontend.js ./dist/
COPY --from=builder /repo/apps/mcp/src/logo.svg ./src/
COPY --from=builder /repo/apps/mcp/src/react.svg ./src/

EXPOSE 3000
USER 65532:65532
CMD ["/app/server"]
